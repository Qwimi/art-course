<div class="about-block">
    <div class="container">
        <div class="row align-items-center about-info">
            <div class="col-12 col-md-6 col-lg-7 border-peach about-info-text">
                <h2 class="headline about-title">
                    Для кого будет полезен курс
                </h2>
                <p>
                    На моем курсе «Петербург сквозь года с Владимиром Заруцким» вы научитесь рисовать акварелью
                    городские пейзажи. Этот курс для тех, кто хочет
                    <span class="text-blue">
                        научиться или усовершенствовать свои навыки в акварели.
                    </span>
                    Уверен, вам понравится!
                </p>
            </div>
            <div class="col-12 col-md-6 col-lg-5 border-peach p-0">
                <img class="w-100" src="assets/images/about/about-illustration.jpg" alt="Иллюстрация для блока о курсе">
            </div>
        </div>

        <h2 class="headline text-center course-materials">Материалы на курс</h2>
        <div class="row course-material-list justify-content-center"></div>

        <hr class="border-peach about-division">
        <p class="text-center">Всё это рекомендации, не обязательно использовать то же самое!</p>
    </div>
</div>

<script>
    $.getJSON('assets/data/course-material.json', function (cards) {
        const container = $('.course-material-list');

        cards.forEach((card, index) => {
            const dropdownHtml = card['dropdown-list'] && card['dropdown-list'].length ? `
            <div class="material-dropdown mb-4">
                <button class="material-dropdown-btn text-blue" 
                        type="button" 
                        data-target="dropdown-${index}" 
                        aria-controls="dropdown-${index}"
                        aria-expanded="false">
                    ${card['dropdown-title'] || 'Список'}
                </button>
                <div class="material-dropdown-wrapper bg-white shadow" id="dropdown-${index}">
                    <ul class="material-dropdown-list mb-0" role="listbox">
                        ${card['dropdown-list'].map(item => `<li class="material-item" role="option">${item}</li>`).join('')}
                    </ul>
                </div>
            </div>
        ` : '';

            const descriptionHtml = card.description ? `<p class="mb-4">${card.description}</p>` : '';

            const cardHtml = `
            <div class="col-6 col-md-4 col-lg-3">
                <div class="course-material-card position-relative text-center">
                    <img src="${card.image}" alt="${card.title}" class="material-illustration mb-4">
                    <h5 class="mb-4 text-blue">${card.title}</h5>
                    ${descriptionHtml}
                    ${dropdownHtml}
                </div>
            </div>
        `;

            container.append(cardHtml);
        });

        // Рассчет padding-top и ширины для тела dropdown
        function initDropdown($dropdown) {
            const $btn = $dropdown.find('.material-dropdown-btn');
            const $wrapper = $dropdown.find('.material-dropdown-wrapper');
            const $list = $wrapper.find('.material-dropdown-list');

            $wrapper.css('display', 'block');

            // Отступ сверху
            const paddingTop = -$btn.position().top + $btn.outerHeight() + 40;

            // Ширина
            const paddingInline = parseFloat($wrapper.css('padding-left')) + parseFloat($wrapper.css('padding-right'));
            const borderWidth = parseFloat($wrapper.css('border-left-width')) + parseFloat($wrapper.css('border-right-width'));
            const totalExtra = paddingInline + borderWidth;
            const contentWidth = $list[0].scrollWidth + totalExtra;

            const maxWidth = $(window).width() * 0.9;
            const finalWidth = Math.min(contentWidth, maxWidth);

            $wrapper.css({
                width: finalWidth,
                paddingTop
            });
        }

        $('.material-dropdown').each(function () {
            const $dropdown = $(this);
            const $wrapper = $dropdown.find('.material-dropdown-wrapper');
            initDropdown($dropdown);
            $wrapper.css('display', 'none');
            $wrapper.data('dropdown', $dropdown);
        });

        // Обработка клика по кнопке
        $('.material-dropdown-btn').click(function () {
            const targetId = $(this).data('target');
            const $wrapper = $('#' + targetId);

            $wrapper.slideToggle(200);

            // Обновляем aria-expanded
            const expanded = $(this).attr('aria-expanded') === 'true';
            $(this).attr('aria-expanded', !expanded);
        });

        // Обновляем ширину и отступы при изменении размера окна
        let resizeTimeout;
        $(window).on('resize', function () {
            clearTimeout(resizeTimeout);

            // Дебаунс - обновляем через 100ms после окончания ресайза
            resizeTimeout = setTimeout(function () {
                $('.material-dropdown').each(function () {
                    const $dropdown = $(this);
                    const $wrapper = $dropdown.find('.material-dropdown-wrapper');

                    if ($wrapper.css('display') !== 'none') {
                        initDropdown($dropdown);
                    }
                });
            }, 500);
        });
    });
</script>